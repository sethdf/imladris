---
# =============================================================================
# Imladris Workstation Configuration
# =============================================================================
# All configurable values extracted from bootstrap.sh
# This is the single source of truth for system state.
#
# Architecture decisions enforced:
#   D34 — Repos ARE production via symlinks
#   D13 — Bitwarden Secrets is source of truth
#   D18 — Windmill via Docker Compose on same EC2
#   D33 — Tailscale-only network access
#
# NVMe Policy (m7gd instances have 237GB NVMe SSD at /local):
#   ON NVMe (/local):  caches, tmp, docker layers, worktrees, build artifacts
#                       — anything ephemeral, rebuildable, or high-IO
#   ON EBS (~/ root):   repos, configs, MEMORY, PRDs, secrets, state files
#                       — anything that must survive instance stop/start
#   Guard all NVMe paths with: when: nvme_available | default(false) | bool
#   Add new cache dirs to nvme_dirs list below so they're auto-created

# --- User & Paths ---
imladris_user: ec2-user
imladris_home: "/home/{{ imladris_user }}"
repos_dir: "{{ imladris_home }}/repos"
claude_dir: "{{ imladris_home }}/.claude"
imladris_repo_dir: "{{ repos_dir }}/imladris"

# --- NVMe Instance Store ---
nvme_mount_point: /local
nvme_fs_label: nvme-local
nvme_mount_opts: defaults,nofail,noatime,discard
nvme_dirs:
  # /local/docker is NOT here — Docker creates it with root ownership via data-root
  - "{{ nvme_mount_point }}/worktrees"
  - "{{ nvme_mount_point }}/tmp"
  - "{{ nvme_mount_point }}/cache/npm"
  - "{{ nvme_mount_point }}/cache/bun"
  - "{{ nvme_mount_point }}/cache/steampipe"
  - "{{ nvme_mount_point }}/cache/triage"

# --- AWS ---
aws_account_id: "767448074758"
aws_region: "us-east-1"

# --- System Packages ---
system_packages:
  # curl-minimal is pre-installed on AL2023 — do NOT add curl (conflicts)
  - wget
  - git
  - jq
  - tar
  - unzip
  - tmux
  - cronie
  # mosh requires EPEL — installed separately in packages role

# --- Docker ---
docker_data_root: "{{ nvme_mount_point }}/docker"
docker_packages:
  - docker
# docker-compose-plugin installed as binary in docker role (not in AL2023 repos)

# --- Tailscale ---
tailscale_hostname: imladris
# Set via --extra-vars, env, or vault. Empty = skip auth.
tailscale_auth_key: ""

# --- Bitwarden Secrets (Decision 13/20) ---
# Set via --extra-vars. Empty = skip BWS setup.
bws_access_token: ""

# --- Node.js ---
nodejs_version: "20"

# --- Git Repositories ---
git_repos:
  - name: PAI
    url: https://github.com/danielmiessler/PAI.git
  - name: imladris
    url: https://github.com/sethdf/imladris.git
  - name: dotfiles
    url: https://github.com/sethdf/dotfiles.git

# --- Claude Code Symlinks (Decision 34) ---
# Source: imladris/pai-config/ (PAI runtime snapshot — skills, hooks, agents)
claude_symlinks:
  - src: "{{ imladris_repo_dir }}/pai-config/skills"
    dest: "{{ claude_dir }}/skills"
  - src: "{{ imladris_repo_dir }}/pai-config/agents"
    dest: "{{ claude_dir }}/agents"
  - src: "{{ imladris_repo_dir }}/pai-config/hooks"
    dest: "{{ claude_dir }}/hooks"

# --- Claude Runtime Directories ---
claude_runtime_dirs:
  - "{{ claude_dir }}/MEMORY/WORK"
  - "{{ claude_dir }}/MEMORY/STATE"
  - "{{ claude_dir }}/MEMORY/LEARNING/REFLECTIONS"
  - "{{ claude_dir }}/projects"
  - "{{ claude_dir }}/logs"
  - "{{ claude_dir }}/state"

# --- Context Seeding ---
context_seed_dir: "{{ imladris_repo_dir }}/context"
memory_seed_dir: "{{ context_seed_dir }}/memory"

# --- Windmill ---
windmill_compose_file: "{{ imladris_repo_dir }}/docker-compose.yml"
windmill_health_url: "http://localhost:8000/api/version"
windmill_health_retries: 60
windmill_health_delay: 5
windmill_api_base: "http://localhost:8000"
windmill_workspace: imladris
windmill_admin_email: "admin@windmill.dev"
# Set via --extra-vars. Required for fresh deploy bootstrap.
windmill_admin_password: ""
windmill_scripts_dir: "{{ imladris_repo_dir }}/windmill"
windmill_wmill_config_dir: "{{ imladris_home }}/.config/windmill"
windmill_schedules:
  - path: f/devops/feed_collector_schedule
    schedule: "0 0 */6 * * *"
    script_path: f/devops/feed_collector
  - path: f/devops/activity_report_schedule
    schedule: "0 0 7 * * *"
    script_path: f/devops/activity_report
  - path: f/devops/contextual_surface_schedule
    schedule: "0 0 */12 * * *"
    script_path: f/devops/contextual_surface

# --- Steampipe ---
steampipe_install_url: "https://steampipe.io/install/steampipe.sh"
steampipe_plugins:
  - aws

# --- mcp-tools ---
mcp_tools_arch: linux-arm64
mcp_tools_url: "https://github.com/nicholasgasior/mcp-tools/releases/latest/download/mcp-tools-{{ mcp_tools_arch }}"

# --- AI Failover ---
ai_failover_dir: "{{ imladris_repo_dir }}/ai-failover"
ai_failover_wrapper: "{{ ai_failover_dir }}/claude-failover"
ai_provider_env: "{{ claude_dir }}/ai-provider.env"
ai_failover_state: "{{ claude_dir }}/ai-failover-state"

# --- Voice Server (Decision 43) ---
voice_server_port: 8888
voice_server_audio_dir: /tmp/voice-audio
voice_server_env_file: "{{ imladris_home }}/.config/voice-server.env"
voice_server_elevenlabs_key: ""  # Set via --extra-vars or populate env file via BWS
bun_bin: "{{ imladris_home }}/.bun/bin/bun"

# --- Settings Template ---
settings_template_candidates:
  - "{{ imladris_repo_dir }}/settings.json.template"
