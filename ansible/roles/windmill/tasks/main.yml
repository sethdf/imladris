---
# =============================================================================
# Windmill (Bootstrap Steps 8 + 11)
# =============================================================================
# Decision 18: Windmill via Docker Compose on same EC2
# Handles: Docker Compose startup, wmill CLI, admin bootstrap,
#          script deployment, and cron schedule creation.

- name: Check if docker-compose.yml exists
  ansible.builtin.stat:
    path: "{{ windmill_compose_file }}"
  register: windmill_compose_stat

- name: Start Windmill services
  when: windmill_compose_stat.stat.exists
  block:
    - name: Check if Windmill .env exists
      ansible.builtin.stat:
        path: "{{ imladris_repo_dir }}/.env"
      register: windmill_env_stat

    - name: Generate Windmill DB password
      ansible.builtin.set_fact:
        windmill_generated_password: "{{ lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits') }}"
      when: not windmill_env_stat.stat.exists

    - name: Create Windmill .env file with generated password
      ansible.builtin.copy:
        content: "WINDMILL_DB_PASSWORD={{ windmill_generated_password }}"
        dest: "{{ imladris_repo_dir }}/.env"
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0600"
      when: not windmill_env_stat.stat.exists

    - name: Create Windmill Postgres data directory on EBS
      ansible.builtin.file:
        path: "{{ imladris_home }}/.windmill/postgres"
        state: directory
        mode: "0755"
      become: true

    - name: Start Windmill via Docker Compose
      ansible.builtin.command: docker compose -f {{ windmill_compose_file }} up -d
      become: true
      register: windmill_compose_result
      changed_when: "'Started' in windmill_compose_result.stderr or 'Creating' in windmill_compose_result.stderr"

    - name: Wait for Windmill healthcheck
      ansible.builtin.uri:
        url: "{{ windmill_health_url }}"
        return_content: true
        status_code: 200
      register: windmill_health
      retries: "{{ windmill_health_retries }}"
      delay: "{{ windmill_health_delay }}"
      until: windmill_health.status == 200
      failed_when: false

    - name: Report Windmill health status
      ansible.builtin.debug:
        msg: "Windmill {{ 'healthy' if windmill_health.status | default(0) == 200 else 'not responding — check docker compose logs' }}"

- name: Skip Windmill (no docker-compose.yml)
  ansible.builtin.debug:
    msg: "docker-compose.yml not found at {{ windmill_compose_file }}. Skipping Windmill."
  when: not windmill_compose_stat.stat.exists

# --- Windmill CLI (wmill) ---

- name: Check if wmill CLI is installed
  ansible.builtin.command: wmill --version
  register: windmill_wmill_check
  changed_when: false
  failed_when: false

- name: Install Windmill CLI via npm
  ansible.builtin.command: npm install -g windmill-cli
  become: true
  changed_when: true
  when: windmill_wmill_check.rc != 0

# --- Windmill Admin Bootstrap (fresh deploy) ---
# On fresh EBS: creates admin user, gets token, configures wmill CLI.
# On existing EBS: Windmill data persists in Postgres, this block is skipped.

- name: Bootstrap Windmill admin and deploy scripts
  when:
    - windmill_health.status | default(0) == 200
    - windmill_admin_password | default('') | length > 0
  block:
    - name: Check if wmill workspace is already configured
      ansible.builtin.stat:
        path: "{{ windmill_wmill_config_dir }}/remotes.ndjson"
      register: windmill_wmill_config_stat

    - name: Create admin user (fresh deploy only — no auth required on empty DB)
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/users/create"
        method: POST
        body_format: json
        body:
          email: "{{ windmill_admin_email }}"
          password: "{{ windmill_admin_password }}"
          super_admin: true
          name: "Admin"
        status_code: [200, 201, 409, 401, 403]
      register: windmill_user_create
      failed_when: false
      no_log: true
      when: not windmill_wmill_config_stat.stat.exists

    - name: Login to Windmill
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/auth/login"
        method: POST
        body_format: json
        body:
          email: "{{ windmill_admin_email }}"
          password: "{{ windmill_admin_password }}"
        status_code: 200
        return_content: true
      register: windmill_login
      no_log: true
      when: not windmill_wmill_config_stat.stat.exists

    - name: Create persistent API token
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/users/tokens/create"
        method: POST
        headers:
          Authorization: "Bearer {{ windmill_login.content }}"
        body_format: json
        body:
          label: "ansible-deploy"
        status_code: 200
        return_content: true
      register: windmill_new_token
      no_log: true
      when: not windmill_wmill_config_stat.stat.exists

    - name: Create wmill config directory
      ansible.builtin.file:
        path: "{{ windmill_wmill_config_dir }}"
        state: directory
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0755"
      when: not windmill_wmill_config_stat.stat.exists

    - name: Write wmill activeWorkspace
      ansible.builtin.copy:
        content: "{{ windmill_workspace }}"
        dest: "{{ windmill_wmill_config_dir }}/activeWorkspace"
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0644"
      when: not windmill_wmill_config_stat.stat.exists

    - name: Write wmill remotes config
      ansible.builtin.copy:
        content: '{"name":"{{ windmill_workspace }}","remote":"{{ windmill_api_base }}/","workspaceId":"{{ windmill_workspace }}","token":"{{ windmill_new_token.content }}"}'
        dest: "{{ windmill_wmill_config_dir }}/remotes.ndjson"
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0600"
      no_log: true
      when: not windmill_wmill_config_stat.stat.exists

# --- Windmill Script Deployment ---
# Pushes all TypeScript scripts from repo to Windmill via wmill CLI.
# Idempotent: wmill push overwrites existing scripts.

- name: Deploy Windmill scripts
  when:
    - windmill_health.status | default(0) == 200
  block:
    - name: Check for windmill scripts directory
      ansible.builtin.stat:
        path: "{{ windmill_scripts_dir }}/f/devops"
      register: windmill_scripts_dir_stat

    - name: Initialize wmill in scripts directory
      ansible.builtin.command:
        cmd: wmill init
        chdir: "{{ windmill_scripts_dir }}"
        creates: "{{ windmill_scripts_dir }}/wmill.yaml"
      when: windmill_scripts_dir_stat.stat.exists | default(false)

    - name: Find Windmill scripts to push
      ansible.builtin.find:
        paths: "{{ windmill_scripts_dir }}/f/devops"
        patterns: "*.ts"
        excludes: "*.script.yaml"
      register: windmill_script_files
      when: windmill_scripts_dir_stat.stat.exists | default(false)

    - name: Push Windmill scripts
      ansible.builtin.command:
        cmd: "wmill script push f/devops/{{ item.path | basename }}"
        chdir: "{{ windmill_scripts_dir }}"
      loop: "{{ windmill_script_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | basename }}"
      changed_when: true
      when: windmill_scripts_dir_stat.stat.exists | default(false)

# --- Windmill Cron Schedules ---
# Creates schedules via API. Idempotent: checks if schedule exists first.

- name: Deploy Windmill schedules
  when:
    - windmill_health.status | default(0) == 200
    - windmill_schedules | default([]) | length > 0
  block:
    - name: Read wmill token from config
      ansible.builtin.command:
        cmd: "python3 -c \"import json; print(json.loads(open('{{ windmill_wmill_config_dir }}/remotes.ndjson').read())['token'])\""
      register: windmill_deploy_token
      changed_when: false
      no_log: true

    - name: Check existing schedules
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/w/{{ windmill_workspace }}/schedules/list"
        headers:
          Authorization: "Bearer {{ windmill_deploy_token.stdout }}"
        return_content: true
      register: windmill_existing_schedules
      no_log: true

    - name: Create Windmill schedules
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/w/{{ windmill_workspace }}/schedules/create"
        method: POST
        headers:
          Authorization: "Bearer {{ windmill_deploy_token.stdout }}"
        body_format: json
        body:
          path: "{{ item.path }}"
          schedule: "{{ item.schedule }}"
          timezone: "America/Los_Angeles"
          script_path: "{{ item.script_path }}"
          is_flow: false
          args: {}
          enabled: true
        status_code: [200, 201, 409]
      loop: "{{ windmill_schedules }}"
      loop_control:
        label: "{{ item.path }}"
      when: item.path not in (windmill_existing_schedules.json | default([]) | map(attribute='path') | list)
      no_log: true

# --- Credential Sync: Bitwarden → Windmill Variables (Decision 13/20) ---
# Uses Python script to handle JSON-valued secrets safely.
# Hyphens in BWS keys → underscores in Windmill paths.
# Idempotent: updates existing, creates new.

- name: Sync Bitwarden secrets to Windmill variables
  when:
    - windmill_health.status | default(0) == 200
    - bws_access_token | default('') | length > 0
  block:
    - name: Read wmill token for credential sync
      ansible.builtin.command:
        cmd: "python3 -c \"import json; print(json.loads(open('{{ windmill_wmill_config_dir }}/remotes.ndjson').read())['token'])\""
      register: windmill_sync_token
      changed_when: false
      no_log: true

    - name: Sync BWS secrets to Windmill variables
      ansible.builtin.script:
        cmd: /dev/stdin
        executable: /usr/bin/python3
      args:
        stdin: |
          import json, subprocess, urllib.request, urllib.error, sys

          API = "{{ windmill_api_base }}/api/w/{{ windmill_workspace }}"
          TOKEN = "{{ windmill_sync_token.stdout }}"
          BWS_TOKEN = "{{ bws_access_token }}"

          # Get BWS secrets
          env = dict(__import__('os').environ)
          env['BWS_ACCESS_TOKEN'] = BWS_TOKEN
          r = subprocess.run(['bws', 'secret', 'list'], capture_output=True, text=True, env=env)
          if r.returncode != 0:
              print(f"bws failed: {r.stderr}", file=sys.stderr)
              sys.exit(1)
          secrets = json.loads(r.stdout)

          # Get existing Windmill variables
          req = urllib.request.Request(f"{API}/variables/list",
              headers={"Authorization": f"Bearer {TOKEN}"})
          with urllib.request.urlopen(req) as resp:
              existing = {v['path'] for v in json.loads(resp.read())}

          synced, errors = 0, 0
          for s in secrets:
              key = s['key'].replace('-', '_')
              path = f"f/devops/{key}"
              value = s['value']

              if path in existing:
                  url = f"{API}/variables/update/{path}"
                  body = json.dumps({"value": value}).encode()
              else:
                  url = f"{API}/variables/create"
                  body = json.dumps({"path": path, "value": value, "is_secret": True,
                      "description": "Synced from Bitwarden Secrets"}).encode()

              req = urllib.request.Request(url, data=body, method='POST',
                  headers={"Authorization": f"Bearer {TOKEN}",
                           "Content-Type": "application/json"})
              try:
                  urllib.request.urlopen(req)
                  synced += 1
              except urllib.error.HTTPError as e:
                  if e.code == 409:
                      synced += 1  # already exists
                  else:
                      print(f"Failed {s['key']}: HTTP {e.code}", file=sys.stderr)
                      errors += 1

          print(f"Synced {synced}/{len(secrets)} secrets ({errors} errors)")
          if errors > 0:
              sys.exit(1)
      no_log: true
      changed_when: true
