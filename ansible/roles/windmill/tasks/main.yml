---
# =============================================================================
# Windmill (Bootstrap Steps 8 + 11)
# =============================================================================
# Decision 18: Windmill via Docker Compose on same EC2
# Handles: Docker Compose startup, wmill CLI, admin bootstrap,
#          script deployment, and cron schedule creation.

- name: Check if docker-compose.yml exists
  ansible.builtin.stat:
    path: "{{ windmill_compose_file }}"
  register: windmill_compose_stat

- name: Start Windmill services
  when: windmill_compose_stat.stat.exists
  block:
    - name: Check if Windmill .env exists
      ansible.builtin.stat:
        path: "{{ imladris_repo_dir }}/.env"
      register: windmill_env_stat

    - name: Generate Windmill DB password
      ansible.builtin.set_fact:
        windmill_generated_password: "{{ lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits') }}"
      when: not windmill_env_stat.stat.exists

    - name: Create Windmill .env file with generated password
      ansible.builtin.copy:
        content: "WINDMILL_DB_PASSWORD={{ windmill_generated_password }}"
        dest: "{{ imladris_repo_dir }}/.env"
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0600"
      when: not windmill_env_stat.stat.exists

    - name: Create Windmill Postgres data directory on EBS
      ansible.builtin.file:
        path: "{{ imladris_home }}/.windmill/postgres"
        state: directory
        mode: "0755"
      become: true

    - name: Start Windmill via Docker Compose
      ansible.builtin.command: docker compose -f {{ windmill_compose_file }} up -d
      become: true
      register: windmill_compose_result
      changed_when: "'Started' in windmill_compose_result.stderr or 'Creating' in windmill_compose_result.stderr"

    # --- State Restore from S3 (before Windmill health check) ---
    # If an S3 backup exists, restore .env, Windmill DB, .wmill config, and ~/.claude/
    # This runs BEFORE admin bootstrap so the restored DB has workspace + scripts + schedules.
    - name: Check if S3 state backup exists
      ansible.builtin.command:
        cmd: aws s3 ls s3://imladris-state-{{ aws_account_id }}/latest/windmill-db.sql.gz --region {{ aws_region }}
      register: s3_backup_check
      changed_when: false
      failed_when: false

    - name: Restore state from S3 backup (if available)
      ansible.builtin.command:
        cmd: bash {{ imladris_repo_dir }}/scripts/state-restore.sh
      become: true
      become_user: "{{ imladris_user }}"
      when: s3_backup_check.rc == 0
      register: state_restore_result
      failed_when: false

    - name: Report state restore result
      ansible.builtin.debug:
        msg: "{{ 'State restored from S3 backup' if state_restore_result.rc | default(1) == 0 else 'No S3 backup found or restore skipped — clean install' }}"

    - name: Wait for Windmill healthcheck
      ansible.builtin.uri:
        url: "{{ windmill_health_url }}"
        return_content: true
        status_code: 200
      register: windmill_health
      retries: "{{ windmill_health_retries }}"
      delay: "{{ windmill_health_delay }}"
      until: windmill_health.status == 200
      failed_when: false

    - name: Report Windmill health status
      ansible.builtin.debug:
        msg: "Windmill {{ 'healthy' if windmill_health.status | default(0) == 200 else 'not responding — check docker compose logs' }}"

- name: Skip Windmill (no docker-compose.yml)
  ansible.builtin.debug:
    msg: "docker-compose.yml not found at {{ windmill_compose_file }}. Skipping Windmill."
  when: not windmill_compose_stat.stat.exists

# --- Windmill CLI (wmill) ---

- name: Check if wmill CLI is installed
  ansible.builtin.command: wmill --version
  register: windmill_wmill_check
  changed_when: false
  failed_when: false

- name: Install Windmill CLI via npm
  ansible.builtin.command: npm install -g windmill-cli
  become: true
  changed_when: true
  when: windmill_wmill_check.rc != 0

# --- Windmill Admin Bootstrap (fresh deploy) ---
# On fresh EBS: creates admin user, gets token, configures wmill CLI.
# On existing EBS: Windmill data persists in Postgres, this block is skipped.

- name: Generate Windmill admin password (if not provided)
  ansible.builtin.set_fact:
    windmill_admin_password: "{{ lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits') }}"
  when: windmill_admin_password | default('') | length == 0

- name: Bootstrap Windmill admin and deploy scripts
  when:
    - windmill_health.status | default(0) == 200
  block:
    - name: Check if wmill workspace is already configured
      ansible.builtin.stat:
        path: "{{ windmill_wmill_config_dir }}/remotes.ndjson"
      register: windmill_wmill_config_stat

    # Windmill CE ships with default admin (admin@windmill.dev / changeme).
    # Login with default creds first, then change password.
    - name: Login to Windmill with default credentials
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/auth/login"
        method: POST
        body_format: json
        body:
          email: "{{ windmill_admin_email }}"
          password: "changeme"
        status_code: [200, 403]
        return_content: true
      register: windmill_default_login
      failed_when: false
      no_log: true
      when: not windmill_wmill_config_stat.stat.exists

    - name: Login to Windmill with custom password (already changed)
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/auth/login"
        method: POST
        body_format: json
        body:
          email: "{{ windmill_admin_email }}"
          password: "{{ windmill_admin_password }}"
        status_code: [200, 401, 403]
        return_content: true
      register: windmill_custom_login
      failed_when: false
      no_log: true
      when:
        - not windmill_wmill_config_stat.stat.exists
        - windmill_default_login.status | default(0) != 200

    - name: Set login result fact
      ansible.builtin.set_fact:
        windmill_login_succeeded: "{{ (windmill_default_login.status | default(0) == 200) or (windmill_custom_login.status | default(0) == 200) }}"
        windmill_login_token: >-
          {{ windmill_default_login.content if windmill_default_login.status | default(0) == 200
             else (windmill_custom_login.content if windmill_custom_login.status | default(0) == 200
             else '') }}
      no_log: true
      when: not windmill_wmill_config_stat.stat.exists

    - name: Warn if Windmill login failed (restored DB with unknown password)
      ansible.builtin.debug:
        msg: >-
          WARNING: Could not login to Windmill with default or generated password.
          This usually means an S3 state restore brought back a DB with a different admin password.
          Skipping admin bootstrap — wmill CLI config will need manual setup or a fresh deploy without restore.
      when:
        - not windmill_wmill_config_stat.stat.exists
        - not (windmill_login_succeeded | default(false) | bool)

    - name: Change default admin password
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/users/setpassword"
        method: POST
        headers:
          Cookie: "token={{ windmill_login_token }}"
        body_format: json
        body:
          password: "{{ windmill_admin_password }}"
        status_code: [200, 204]
      failed_when: false
      no_log: true
      when:
        - not windmill_wmill_config_stat.stat.exists
        - windmill_login_succeeded | default(false) | bool
        - windmill_default_login.status | default(0) == 200

    - name: Create persistent API token
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/users/tokens/create"
        method: POST
        headers:
          Cookie: "token={{ windmill_login_token }}"
        body_format: json
        body:
          label: "ansible-deploy"
        status_code: 200
        return_content: true
      register: windmill_new_token
      no_log: true
      when:
        - not windmill_wmill_config_stat.stat.exists
        - windmill_login_succeeded | default(false) | bool

    - name: Create wmill config directory
      ansible.builtin.file:
        path: "{{ windmill_wmill_config_dir }}"
        state: directory
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0755"
      when:
        - not windmill_wmill_config_stat.stat.exists
        - windmill_login_succeeded | default(false) | bool

    - name: Write wmill activeWorkspace
      ansible.builtin.copy:
        content: "{{ windmill_workspace }}"
        dest: "{{ windmill_wmill_config_dir }}/activeWorkspace"
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0644"
      when:
        - not windmill_wmill_config_stat.stat.exists
        - windmill_login_succeeded | default(false) | bool

    - name: Write wmill remotes config
      ansible.builtin.copy:
        content: '{"name":"{{ windmill_workspace }}","remote":"{{ windmill_api_base }}/","workspaceId":"{{ windmill_workspace }}","token":"{{ windmill_new_token.content }}"}'
        dest: "{{ windmill_wmill_config_dir }}/remotes.ndjson"
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0600"
      no_log: true
      when:
        - not windmill_wmill_config_stat.stat.exists
        - windmill_login_succeeded | default(false) | bool

# --- Check wmill config before script/schedule/cred-sync blocks ---
# If bootstrap was skipped (e.g., restored DB with unknown password), these blocks
# depend on remotes.ndjson existing from a previous run or state restore.

- name: Check if wmill config exists (post-bootstrap)
  ansible.builtin.stat:
    path: "{{ windmill_wmill_config_dir }}/remotes.ndjson"
  register: windmill_config_ready

# --- Windmill Script Deployment ---
# Pushes all TypeScript scripts from repo to Windmill via wmill CLI.
# Idempotent: wmill push overwrites existing scripts.

- name: Deploy Windmill scripts
  when:
    - windmill_health.status | default(0) == 200
    - windmill_config_ready.stat.exists | default(false)
  block:
    - name: Check for windmill scripts directory
      ansible.builtin.stat:
        path: "{{ windmill_scripts_dir }}/f/devops"
      register: windmill_scripts_dir_stat

    - name: Initialize wmill in scripts directory
      ansible.builtin.command:
        cmd: wmill init
        chdir: "{{ windmill_scripts_dir }}"
        creates: "{{ windmill_scripts_dir }}/wmill.yaml"
      when: windmill_scripts_dir_stat.stat.exists | default(false)
      failed_when: false

    - name: Find Windmill scripts to push
      ansible.builtin.find:
        paths: "{{ windmill_scripts_dir }}/f/devops"
        patterns: "*.ts"
        excludes: "*.script.yaml"
      register: windmill_script_files
      when: windmill_scripts_dir_stat.stat.exists | default(false)

    - name: Push Windmill scripts
      ansible.builtin.command:
        cmd: "wmill script push f/devops/{{ item.path | basename }}"
        chdir: "{{ windmill_scripts_dir }}"
      loop: "{{ windmill_script_files.files | default([]) }}"
      loop_control:
        label: "{{ item.path | basename }}"
      changed_when: true
      when: windmill_scripts_dir_stat.stat.exists | default(false)

# --- Windmill Cron Schedules ---
# Creates schedules via API. Idempotent: checks if schedule exists first.

- name: Deploy Windmill schedules
  when:
    - windmill_health.status | default(0) == 200
    - windmill_config_ready.stat.exists | default(false)
    - windmill_schedules | default([]) | length > 0
  block:
    - name: Read wmill token from config
      ansible.builtin.command:
        cmd: "python3 -c \"import json; print(json.loads(open('{{ windmill_wmill_config_dir }}/remotes.ndjson').read())['token'])\""
      register: windmill_deploy_token
      changed_when: false
      no_log: true

    - name: Check existing schedules
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/w/{{ windmill_workspace }}/schedules/list"
        headers:
          Authorization: "Bearer {{ windmill_deploy_token.stdout }}"
        return_content: true
      register: windmill_existing_schedules
      no_log: true

    - name: Create Windmill schedules
      ansible.builtin.uri:
        url: "{{ windmill_api_base }}/api/w/{{ windmill_workspace }}/schedules/create"
        method: POST
        headers:
          Authorization: "Bearer {{ windmill_deploy_token.stdout }}"
        body_format: json
        body:
          path: "{{ item.path }}"
          schedule: "{{ item.schedule }}"
          timezone: "America/Los_Angeles"
          script_path: "{{ item.script_path }}"
          is_flow: false
          args: {}
          enabled: true
        status_code: [200, 201, 409]
      loop: "{{ windmill_schedules }}"
      loop_control:
        label: "{{ item.path }}"
      when: item.path not in (windmill_existing_schedules.json | default([]) | map(attribute='path') | list)
      no_log: true

# --- Credential Sync: Bitwarden → Windmill Variables (Decision 13/20) ---
# Uses Python script to handle JSON-valued secrets safely.
# Hyphens in BWS keys → underscores in Windmill paths.
# Idempotent: updates existing, creates new.

- name: Sync Bitwarden secrets to Windmill variables
  when:
    - windmill_health.status | default(0) == 200
    - windmill_config_ready.stat.exists | default(false)
    - bws_access_token | default('') | length > 0
  block:
    - name: Read wmill token for credential sync
      ansible.builtin.command:
        cmd: "python3 -c \"import json; print(json.loads(open('{{ windmill_wmill_config_dir }}/remotes.ndjson').read())['token'])\""
      register: windmill_sync_token
      changed_when: false
      no_log: true

    - name: Sync BWS secrets to Windmill variables
      ansible.builtin.command:
        cmd: python3 {{ imladris_repo_dir }}/scripts/windmill-sync.py
      environment:
        BWS_ACCESS_TOKEN: "{{ bws_access_token }}"
        WMILL_TOKEN: "{{ windmill_sync_token.stdout }}"
        WMILL_API: "{{ windmill_api_base }}/api/w/{{ windmill_workspace }}"
      no_log: true
      changed_when: true

# --- State Backup Cron (Decision 8 extension) ---
# Backs up all stateful data to S3 every 6 hours, encrypted with CMK.
# Complements hourly DLM EBS snapshots with portable, granular backups.

- name: Install state backup cron (every 6 hours)
  ansible.builtin.cron:
    name: "PAI state backup to S3"
    minute: "0"
    hour: "*/6"
    job: "bash {{ imladris_repo_dir }}/scripts/state-backup.sh 2>&1 | tail -5 >> {{ imladris_home }}/.claude/logs/state-backup-cron.log"
    user: "{{ imladris_user }}"

- name: Install cache eviction cron (daily)
  ansible.builtin.cron:
    name: "Triage cache eviction"
    minute: "30"
    hour: "3"
    job: "bash {{ imladris_repo_dir }}/scripts/cache-evict.sh 2>&1 >> {{ imladris_home }}/.claude/logs/cache-evict.log"
    user: "{{ imladris_user }}"
  when: nvme_available | default(false) | bool

- name: Run initial state backup
  ansible.builtin.command:
    cmd: bash {{ imladris_repo_dir }}/scripts/state-backup.sh
  become: true
  become_user: "{{ imladris_user }}"
  changed_when: true
  failed_when: false
  when: windmill_health.status | default(0) == 200
