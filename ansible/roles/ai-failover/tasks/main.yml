---
# =============================================================================
# AI Failover Setup (Bootstrap Step 13)
# =============================================================================
# Reactive failover: Anthropic <-> Bedrock

- name: Check if failover wrapper exists
  ansible.builtin.stat:
    path: "{{ ai_failover_wrapper }}"
  register: failover_wrapper_stat

- name: AI failover setup
  when: failover_wrapper_stat.stat.exists
  block:
    - name: Make failover wrapper executable
      ansible.builtin.file:
        path: "{{ ai_failover_wrapper }}"
        mode: "0755"

    - name: Create ai-provider.env
      ansible.builtin.copy:
        content: |
          # Auto-generated by Ansible â€” do not edit manually
          # Provider: Anthropic (direct)
        dest: "{{ ai_provider_env }}"
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0644"
        force: false

    - name: Create ai-failover-state
      ansible.builtin.copy:
        content: "0"
        dest: "{{ ai_failover_state }}"
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0644"
        force: false

    - name: Add claude failover wrapper to bashrc
      ansible.builtin.blockinfile:
        path: "{{ imladris_home }}/.bashrc"
        marker: "# {mark} ANSIBLE MANAGED - Claude AI Failover"
        block: |
          # Claude AI reactive failover (Anthropic <-> Bedrock)
          claude() { {{ ai_failover_wrapper }} "$@"; }
        create: true
        owner: "{{ imladris_user }}"
        group: "{{ imladris_user }}"
        mode: "0644"

    - name: Clean up old systemd failover units
      ansible.builtin.file:
        path: "{{ imladris_home }}/.config/systemd/user/{{ item }}"
        state: absent
      loop:
        - claude-ai-failover.timer
        - claude-ai-failover.service

- name: Skip AI failover (wrapper not found)
  ansible.builtin.debug:
    msg: "Failover wrapper not found at {{ ai_failover_wrapper }}. Skipping."
  when: not failover_wrapper_stat.stat.exists
