---
# =============================================================================
# Tailscale VPN (Bootstrap Step 2 — Tailscale, Step 8 — auth)
# =============================================================================
# Decision 33: Tailscale-only network access

- name: Check if Tailscale is installed
  ansible.builtin.command: which tailscale
  register: tailscale_check
  changed_when: false
  failed_when: false

- name: Install Tailscale
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      curl -fsSL https://tailscale.com/install.sh | bash
    executable: /bin/bash
  become: true
  changed_when: true
  when: tailscale_check.rc != 0

- name: Enable and start tailscaled
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started
  become: true

- name: Check Tailscale status
  ansible.builtin.command: tailscale status
  register: tailscale_status
  changed_when: false
  failed_when: false

- name: Authenticate Tailscale
  ansible.builtin.command: >
    tailscale up
    --authkey {{ tailscale_auth_key }}
    --hostname {{ tailscale_hostname }}
    --ssh
  become: true
  changed_when: true
  when:
    - tailscale_auth_key | length > 0
    - tailscale_status.rc != 0
