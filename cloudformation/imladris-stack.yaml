AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Imladris v2 cloud workstation — creates dedicated VPC with internet gateway,
  EC2 instance with customer-managed KMS encryption, automated UserData bootstrap
  (SSM secrets, Tailscale, repo clone), IAM role for cross-account AssumeRole,
  zero-inbound security group (Tailscale-only), hourly DLM EBS snapshots,
  Bedrock VPC endpoint (model invocation failover), and S3 state backup. No long-lived credentials anywhere.

Parameters:
  InstanceType:
    Type: String
    Default: m7gd.xlarge
    Description: EC2 instance type (Graviton3, NVMe instance store, non-burstable — 4 vCPU, 16GB)
    AllowedValues:
      - m7g.xlarge
      - m7gd.large
      - m7gd.xlarge
      - m7gd.2xlarge
      - m8g.xlarge
      - m8gd.xlarge
      - m8gd.2xlarge
      - t4g.large
      - t4g.xlarge
      - t4g.2xlarge

  AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-arm64
    Description: SSM parameter path for AMI lookup (Amazon Linux 2023 ARM64)

  AdminPrincipalArn:
    Type: String
    Description: ARN of admin principal (IAM user or SSO role) for MFA-locked KMS key operations
    AllowedPattern: 'arn:aws:iam::\d{12}:(user|role)/.+'
    ConstraintDescription: Must be a valid IAM user or role ARN

  TargetAccountIds:
    Type: CommaDelimitedList
    Description: Comma-separated list of AWS account IDs for cross-account AssumeRole

  UseExistingStorage:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Set to true when redeploying with retained KMS key and S3 bucket from previous stack

  ExistingKmsKeyArn:
    Type: String
    Default: ''
    Description: ARN of existing KMS key (required when UseExistingStorage=true)

Conditions:
  CreateNewStorage: !Equals [!Ref UseExistingStorage, 'false']

Resources:
  # ============================================================
  # VPC and Networking
  # Dedicated VPC for the workstation with internet gateway.
  # Single public subnet in first AZ. Zero inbound via SG.
  # ============================================================
  WorkstationVpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: ImladrisVpc
        - Key: Project
          Value: Imladris

  WorkstationSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref WorkstationVpc
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: ImladrisPublicSubnet
        - Key: Project
          Value: Imladris

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: ImladrisIgw
        - Key: Project
          Value: Imladris

  GatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref WorkstationVpc
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref WorkstationVpc
      Tags:
        - Key: Name
          Value: ImladrisPublicRouteTable
        - Key: Project
          Value: Imladris

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: GatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref WorkstationSubnet
      RouteTableId: !Ref PublicRouteTable

  # ============================================================
  # KMS Key for EBS encryption (Decision 30)
  # Customer-managed CMK with MFA-locked admin operations.
  # Root has emergency access. Seth can admin only with MFA.
  # EC2 role can use the key for encrypt/decrypt (no admin).
  # ============================================================
  WorkstationKmsKey:
    Type: AWS::KMS::Key
    Condition: CreateNewStorage
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Description: Imladris workstation EBS encryption key — MFA-locked admin
      KeyUsage: ENCRYPT_DECRYPT
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: RootEmergencyAccess
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'

          - Sid: SethKeyAdminWithMFA
            Effect: Allow
            Principal:
              AWS: !Ref AdminPrincipalArn
            Action:
              - kms:Create*
              - kms:Describe*
              - kms:Enable*
              - kms:List*
              - kms:Put*
              - kms:Update*
              - kms:Revoke*
              - kms:Disable*
              - kms:Get*
              - kms:Delete*
              - kms:TagResource
              - kms:UntagResource
              - kms:ScheduleKeyDeletion
              - kms:CancelKeyDeletion
            Resource: '*'
            Condition:
              Bool:
                'aws:MultiFactorAuthPresent': 'true'

          - Sid: SethKeyReadWithoutMFA
            Effect: Allow
            Principal:
              AWS: !Ref AdminPrincipalArn
            Action:
              - kms:Describe*
              - kms:Get*
              - kms:List*
            Resource: '*'

      Tags:
        - Key: Name
          Value: ImladrisWorkstationKey
        - Key: Project
          Value: Imladris

  WorkstationKmsAlias:
    Type: AWS::KMS::Alias
    Condition: CreateNewStorage
    Properties:
      AliasName: alias/workstation-ebs
      TargetKeyId: !Ref WorkstationKmsKey

  # ============================================================
  # Security Group (Decision 33)
  # Zero public inbound ports. All access via Tailscale mesh.
  # All outbound allowed for AWS APIs, Tailscale, packages.
  # ============================================================
  WorkstationSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Imladris workstation - zero inbound, Tailscale-only access
      VpcId: !Ref WorkstationVpc
      SecurityGroupIngress: []
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound (AWS APIs, Tailscale DERP, package repos)
      Tags:
        - Key: Name
          Value: ImladrisWorkstationSG
        - Key: Project
          Value: Imladris

  # ============================================================
  # IAM Role for EC2 (Decision 16 + 17)
  # No long-lived credentials. EC2 assumes this role via instance profile.
  # Inline policy allows AssumeRole to ImladrisReadOnly and
  # Bedrock policy enables AI failover when Anthropic API is unavailable.
  # ImladrisReadWrite in all target accounts.
  # KB/guardrails removed — add back when data volume warrants it.
  # ============================================================
  WorkstationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: ImladrisWorkstationRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: CrossAccountAssumeRole
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AssumeTargetAccountRoles
                Effect: Allow
                Action: sts:AssumeRole
                Resource:
                  - 'arn:aws:iam::*:role/ImladrisReadOnly'
                  - 'arn:aws:iam::*:role/ImladrisReadWrite'
                Condition:
                  ForAnyValue:StringEquals:
                    'aws:ResourceAccount': !Ref TargetAccountIds
        - PolicyName: KmsUsage
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: UseWorkstationKmsKey
                Effect: Allow
                Action:
                  - kms:Encrypt
                  - kms:Decrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                  - kms:DescribeKey
                Resource: !If [CreateNewStorage, !GetAtt WorkstationKmsKey.Arn, !Ref ExistingKmsKeyArn]
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ClaudeCodeBedrockFailover
                Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:ListInferenceProfiles
                Resource: '*'
        - PolicyName: SsmParameterAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ReadBootstrapSecrets
                Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/imladris/*'
        - PolicyName: StateBackupAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: StateBackupBucketReadWrite
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                  - s3:DeleteObject
                Resource:
                  - !If [CreateNewStorage, !GetAtt StateBackupBucket.Arn, !Sub 'arn:aws:s3:::imladris-state-${AWS::AccountId}']
                  - !If [CreateNewStorage, !Sub '${StateBackupBucket.Arn}/*', !Sub 'arn:aws:s3:::imladris-state-${AWS::AccountId}/*']
      Tags:
        - Key: Name
          Value: ImladrisWorkstationRole
        - Key: Project
          Value: Imladris

  WorkstationInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: ImladrisWorkstationProfile
      Roles:
        - !Ref WorkstationRole

  # ============================================================
  # EC2 Instance (Decision 18)
  # t3.xlarge, 100GB gp3, encrypted with customer-managed CMK.
  # Tagged Workstation=true for DLM snapshot targeting.
  # UserData bootstraps the workstation.
  # ============================================================
  WorkstationInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref AmiId
      IamInstanceProfile: !Ref WorkstationInstanceProfile
      SubnetId: !Ref WorkstationSubnet
      SecurityGroupIds:
        - !GetAtt WorkstationSecurityGroup.GroupId
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 100
            VolumeType: gp3
            Iops: 3000
            Encrypted: true
            KmsKeyId: !If [CreateNewStorage, !GetAtt WorkstationKmsKey.Arn, !Ref ExistingKmsKeyArn]
            DeleteOnTermination: false
        - DeviceName: /dev/sdb
          VirtualName: ephemeral0
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euxo pipefail
          exec > /var/log/imladris-bootstrap.log 2>&1

          # Upload logs to S3 and signal CloudFormation on exit (success or failure)
          cleanup_and_signal() {
            EXIT_CODE=$?
            echo "=== Bootstrap finished with exit code $EXIT_CODE at $(date -u) ==="
            # Dump last 300 lines to serial console for EC2 get-console-output debugging
            echo "=== ANSIBLE LOG (last 300 lines) ===" > /dev/ttyS0 2>/dev/null || true
            tail -300 /var/log/imladris-bootstrap.log > /dev/ttyS0 2>/dev/null || true
            # Upload bootstrap log to S3 for post-mortem (best-effort)
            aws s3 cp /var/log/imladris-bootstrap.log \
              s3://imladris-state-${AWS::AccountId}/bootstrap-logs/$(date -u +%Y%m%d-%H%M%S)-exit${!EXIT_CODE}.log \
              --region ${AWS::Region} 2>/dev/null || true
            # Signal CF immediately (fail-fast on errors instead of waiting for timeout)
            /opt/aws/bin/cfn-signal -e $EXIT_CODE --stack ${AWS::StackName} --resource WorkstationInstance --region ${AWS::Region}
          }
          trap cleanup_and_signal EXIT

          # Wait for internet connectivity FIRST (IGW propagation can lag instance launch)
          for i in $(seq 1 30); do
            if curl -sf --max-time 5 https://github.com >/dev/null 2>&1; then
              echo "Internet connectivity confirmed (attempt $i)"
              break
            fi
            echo "Waiting for internet... (attempt $i/30)"
            sleep 10
          done

          # Read Tailscale auth key from SSM (encrypted with workstation CMK)
          # Retry: IAM role credentials may take a few seconds after boot
          for i in $(seq 1 5); do
            TAILSCALE_AUTH_KEY=$(aws ssm get-parameter \
              --name "/imladris/tailscale-auth-key" \
              --with-decryption \
              --query 'Parameter.Value' \
              --output text \
              --region ${AWS::Region} 2>&1) && break
            echo "SSM get-parameter failed (attempt $i/5), retrying in 5s..."
            sleep 5
          done
          test -n "$TAILSCALE_AUTH_KEY" || { echo "FATAL: Failed to retrieve Tailscale auth key from SSM"; exit 1; }

          # Install Ansible and git
          dnf install -y git python3-pip
          pip3 install ansible-core
          sudo -u ec2-user /usr/local/bin/ansible-galaxy collection install ansible.posix

          # Clone imladris repo
          mkdir -p /home/ec2-user/repos
          for i in $(seq 1 3); do
            if git clone https://github.com/sethdf/imladris.git /home/ec2-user/repos/imladris; then
              break
            fi
            echo "git clone failed (attempt $i/3), retrying in 10s..."
            rm -rf /home/ec2-user/repos/imladris
            sleep 10
          done
          chown -R ec2-user:ec2-user /home/ec2-user/repos

          # Run Ansible playbook as ec2-user (cd ensures ansible.cfg + inventory.yml are found)
          # --limit imladris-local: only target localhost (imladris-1 is for remote runs from Aurora)
          cd /home/ec2-user/repos/imladris/ansible
          sudo -u ec2-user /usr/local/bin/ansible-playbook \
            site.yml \
            --limit imladris-local \
            -e "tailscale_auth_key=$TAILSCALE_AUTH_KEY"
      Tags:
        - Key: Name
          Value: Imladris
        - Key: Workstation
          Value: 'true'
        - Key: Project
          Value: Imladris
    # CreationPolicy temporarily disabled for diagnostic deploy
    # CreationPolicy:
    #   ResourceSignal:
    #     Timeout: PT15M

  # ============================================================
  # DLM Lifecycle Policy (Decision 8)
  # Hourly EBS snapshots targeting volumes tagged Workstation=true.
  # Retains 24 snapshots (24 hours of hourly backups).
  # ============================================================
  DlmRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: ImladrisDlmLifecycleRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: dlm.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSDataLifecycleManagerServiceRole
      Policies:
        - PolicyName: DlmKmsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AllowKmsForSnapshots
                Effect: Allow
                Action:
                  - kms:Encrypt
                  - kms:Decrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                  - kms:DescribeKey
                  - kms:CreateGrant
                  - kms:ListGrants
                Resource: !If [CreateNewStorage, !GetAtt WorkstationKmsKey.Arn, !Ref ExistingKmsKeyArn]
      Tags:
        - Key: Name
          Value: ImladrisDlmRole
        - Key: Project
          Value: Imladris

  SnapshotLifecyclePolicy:
    Type: AWS::DLM::LifecyclePolicy
    Properties:
      Description: Hourly EBS snapshots for Imladris workstation volumes
      State: ENABLED
      ExecutionRoleArn: !GetAtt DlmRole.Arn
      PolicyDetails:
        ResourceTypes:
          - VOLUME
        TargetTags:
          - Key: Workstation
            Value: 'true'
        Schedules:
          - Name: HourlySnapshots
            CreateRule:
              Interval: 1
              IntervalUnit: HOURS
            RetainRule:
              Count: 24
            TagsToAdd:
              - Key: CreatedBy
                Value: DLM-Imladris
              - Key: Project
                Value: Imladris
            CopyTags: true
      Tags:
        - Key: Name
          Value: ImladrisSnapshotPolicy
        - Key: Project
          Value: Imladris

  # ============================================================
  # S3 State Backup Bucket
  # Encrypted with same CMK as EBS. Locked to workstation role ONLY.
  # Stores: ~/.claude/ (conversations, memory, logs, state),
  # Windmill Postgres dump, .env, wmill config.
  # No other principal can read this data.
  # ============================================================
  StateBackupBucket:
    Type: AWS::S3::Bucket
    Condition: CreateNewStorage
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub 'imladris-state-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !GetAtt WorkstationKmsKey.Arn
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: ExpireOldVersions
            Status: Enabled
            NoncurrentVersionExpiration:
              NoncurrentDays: 30
      Tags:
        - Key: Name
          Value: ImladrisStateBackupBucket
        - Key: Project
          Value: Imladris

  StateBackupBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: CreateNewStorage
    Properties:
      Bucket: !Ref StateBackupBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Only the workstation role and root can access this bucket.
          # Root access requires YubiKey MFA (Decision 31).
          # No other IAM entity — not even admin SSO role — can read objects.
          - Sid: DenyAllExceptWorkstationAndRoot
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !GetAtt StateBackupBucket.Arn
              - !Sub '${StateBackupBucket.Arn}/*'
            Condition:
              ArnNotLike:
                'aws:PrincipalArn':
                  - !GetAtt WorkstationRole.Arn
                  - !Sub 'arn:aws:iam::${AWS::AccountId}:root'
          # Deny any upload that doesn't use KMS encryption
          - Sid: DenyUnencryptedUploads
            Effect: Deny
            Principal: '*'
            Action: 's3:PutObject'
            Resource: !Sub '${StateBackupBucket.Arn}/*'
            Condition:
              StringNotEquals:
                's3:x-amz-server-side-encryption': 'aws:kms'
          # Deny non-TLS connections
          - Sid: EnforceTlsOnly
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !GetAtt StateBackupBucket.Arn
              - !Sub '${StateBackupBucket.Arn}/*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'

  # ============================================================
  # Bedrock VPC Endpoint Security Group
  # Allows HTTPS only from the workstation security group.
  # ============================================================
  BedrockEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Bedrock VPC endpoint - HTTPS from workstation only
      VpcId: !Ref WorkstationVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !GetAtt WorkstationSecurityGroup.GroupId
          Description: HTTPS from workstation to Bedrock endpoints
      SecurityGroupEgress: []
      Tags:
        - Key: Name
          Value: ImladrisBedrockEndpointSG
        - Key: Project
          Value: Imladris

  # ============================================================
  # Bedrock VPC Endpoints (PrivateLink)
  # All Bedrock API traffic stays within VPC — never public internet.
  # ============================================================
  BedrockRuntimeEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref WorkstationVpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.bedrock-runtime'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref WorkstationSubnet
      SecurityGroupIds:
        - !GetAtt BedrockEndpointSecurityGroup.GroupId
      PrivateDnsEnabled: true
      Tags:
        - Key: Name
          Value: ImladrisBedrockRuntimeEndpoint
        - Key: Project
          Value: Imladris


Outputs:
  InstanceId:
    Description: EC2 instance ID of the Imladris workstation
    Value: !Ref WorkstationInstance
    Export:
      Name: !Sub '${AWS::StackName}-InstanceId'

  InstancePrivateIp:
    Description: Private IP address (accessible via Tailscale)
    Value: !GetAtt WorkstationInstance.PrivateIp
    Export:
      Name: !Sub '${AWS::StackName}-PrivateIp'

  KmsKeyId:
    Condition: CreateNewStorage
    Description: KMS key ID for EBS encryption
    Value: !Ref WorkstationKmsKey
    Export:
      Name: !Sub '${AWS::StackName}-KmsKeyId'

  KmsKeyArn:
    Condition: CreateNewStorage
    Description: KMS key ARN for EBS encryption
    Value: !GetAtt WorkstationKmsKey.Arn
    Export:
      Name: !Sub '${AWS::StackName}-KmsKeyArn'

  SecurityGroupId:
    Description: Security group ID (zero inbound)
    Value: !GetAtt WorkstationSecurityGroup.GroupId
    Export:
      Name: !Sub '${AWS::StackName}-SecurityGroupId'

  WorkstationRoleArn:
    Description: IAM role ARN for the workstation EC2 instance
    Value: !GetAtt WorkstationRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-WorkstationRoleArn'

  SnapshotPolicyId:
    Description: DLM snapshot lifecycle policy ID
    Value: !Ref SnapshotLifecyclePolicy
    Export:
      Name: !Sub '${AWS::StackName}-SnapshotPolicyId'

  StateBackupBucketName:
    Condition: CreateNewStorage
    Description: S3 bucket for encrypted state backups
    Value: !Ref StateBackupBucket
    Export:
      Name: !Sub '${AWS::StackName}-StateBackupBucketName'

  StateBackupBucketArn:
    Condition: CreateNewStorage
    Description: ARN of the state backup S3 bucket
    Value: !GetAtt StateBackupBucket.Arn
    Export:
      Name: !Sub '${AWS::StackName}-StateBackupBucketArn'

  BedrockRuntimeEndpointId:
    Description: VPC endpoint ID for Bedrock runtime
    Value: !Ref BedrockRuntimeEndpoint
    Export:
      Name: !Sub '${AWS::StackName}-BedrockRuntimeEndpointId'

  VpcId:
    Description: VPC ID for the Imladris workstation
    Value: !Ref WorkstationVpc
    Export:
      Name: !Sub '${AWS::StackName}-VpcId'

  SubnetId:
    Description: Subnet ID for the Imladris workstation
    Value: !Ref WorkstationSubnet
    Export:
      Name: !Sub '${AWS::StackName}-SubnetId'
